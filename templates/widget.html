<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moose Widget</title>
    
    <!-- Grist Plugin API -->
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    
    <!-- DSFR CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='dsfr/dsfr.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='custom.css') }}">
    
    <style>
        body {
            margin: 0;
            padding: 1rem;
            font-family: Marianne, sans-serif;
        }
        .widget-container {
            max-width: 100%;
        }
        .fr-input-group {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <!-- Header Marianne -->
    <header class="fr-header" style="margin: -1rem -1rem 1rem -1rem;">
        <div class="fr-header__body">
            <div class="fr-container">
                <div class="fr-header__body-row">
                    <div class="fr-header__brand fr-enlarge-link">
                        <div class="fr-header__brand-top">
                            <div class="fr-header__logo">
                                <p class="fr-logo">
                                    Minist√®re<br>de l'agriculture<br>et de la souverainet√©<br>alimentaire
                                </p>
                            </div>
                        </div>
                        <div class="fr-header__service">
                            <p class="fr-header__service-title">
                                ü¶å Moose
                            </p>
                            <p class="fr-header__service-tagline">
                                G√©n√©rateur d'URLs d'API Grist
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="widget-container">

        <!-- Formulaire -->
        <div id="widgetForm">
            <!-- Token API - Saisie manuelle -->
            <div class="fr-input-group">
                <label class="fr-label" for="api_key">
                    Token API Grist
                    <span class="fr-hint-text">Requis - Saisissez votre token personnel</span>
                </label>
                <input
                    class="fr-input"
                    type="password"
                    id="api_key"
                    name="api_key"
                    required
                    placeholder="Votre token API Grist"
                />
            </div>

            <!-- Document ID - Saisie manuelle -->
            <div class="fr-input-group">
                <label class="fr-label" for="doc_id">
                    Document ID
                    <span class="fr-hint-text">Trouvez l'ID dans l'URL de votre document Grist</span>
                </label>
                <input
                    class="fr-input"
                    type="text"
                    id="doc_id"
                    name="doc_id"
                    required
                    placeholder="Ex: cTdjBRNu26yTzGusvQKffu"
                />
                <div class="fr-hint-text" style="margin-top: 0.25rem;">
                    URL Grist : https://grist.../doc/<strong>VOTRE_DOC_ID</strong>/...
                </div>
            </div>

            <!-- Bouton test API -->
            <div class="fr-mb-3w">
                <button
                    class="fr-btn fr-btn--secondary fr-btn--sm"
                    type="button"
                    id="testApiBtn"
                >
                    Tester le token
                </button>
            </div>

            <!-- Bouton charger tables -->
            <div class="fr-mb-3w">
                <button
                    type="button"
                    class="fr-btn fr-btn--secondary"
                    id="loadTablesBtn"
                    disabled
                >
                    Charger les tables
                </button>
            </div>

            <!-- S√©lection table -->
            <div class="fr-select-group fr-mb-3w">
                <label class="fr-label" for="table_name">Table</label>
                <select class="fr-select" id="table_name" name="table_name" required disabled>
                    <option value="">-- Charger d'abord les tables --</option>
                </select>
            </div>

            <!-- S√©lection colonne -->
            <div class="fr-select-group fr-mb-3w">
                <label class="fr-label" for="column_name">Colonne de filtre</label>
                <select class="fr-select" id="column_name" name="column_name" required disabled>
                    <option value="">-- Choisir d'abord une table --</option>
                </select>
            </div>

            <!-- Bouton g√©n√©rer -->
            <div class="fr-mb-3w">
                <button type="button" class="fr-btn" id="generateBtn" disabled>
                    G√©n√©rer l'URL
                </button>
            </div>
        </div>

        <!-- R√©sultat -->
        <div id="result" style="display: none"></div>
        
        <!-- Chargement -->
        <div id="loading" style="display: none" class="fr-alert fr-alert--info">
            <p>G√©n√©ration en cours...</p>
        </div>
    </div>

    <!-- Footer -->
    <footer class="fr-footer" role="contentinfo" style="margin: 1rem -1rem -1rem -1rem;">
        <div class="fr-container">
            <div class="fr-footer__body">
                <div class="fr-footer__brand fr-enlarge-link">
                    <p class="fr-logo">
                        Minist√®re<br>de l'agriculture<br>et de la souverainet√©<br>alimentaire
                    </p>
                </div>
                <div class="fr-footer__content">
                    <p class="fr-footer__content-desc">
                        Widget Grist - Outil de g√©n√©ration d'URLs d'API Grist
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <!-- Modale -->
    <dialog aria-labelledby="modal-title" role="dialog" id="modal" class="fr-modal">
        <div class="fr-container fr-container--fluid fr-container-md">
            <div class="fr-grid-row fr-grid-row--center">
                <div class="fr-col-12">
                    <div class="fr-modal__body">
                        <div class="fr-modal__header">
                            <button class="fr-btn--close fr-btn" aria-controls="modal" title="Fermer">
                                Fermer
                            </button>
                        </div>
                        <div class="fr-modal__content">
                            <h1 id="modal-title" class="fr-modal__title">Information</h1>
                            <p id="modal-text">Message...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </dialog>

    <!-- Templates -->
    <template id="result-success-template">
        <div class="fr-alert fr-alert--success fr-mb-3w">
            <h3 class="fr-alert__title">URL generee avec succes</h3>
        </div>
        <div class="fr-card fr-card--no-arrow fr-mb-3w">
            <div class="fr-card__body">
                <div class="fr-card__content">
                    <div class="fr-highlight fr-mb-2w">
                        <pre id="generated-url" class="fr-text--sm" style="word-break: break-all;"></pre>
                    </div>
                    <div class="fr-mb-2w">
                        <dl class="fr-metadata">
                            <dt>Document :</dt>
                            <dd id="doc-name">-</dd>
                            <dt>Table :</dt>
                            <dd id="table-name">-</dd>
                            <dt>Colonne :</dt>
                            <dd id="column-name">-</dd>
                        </dl>
                    </div>
                    <div class="fr-btns-group fr-btns-group--inline">
                        <button type="button" class="fr-btn fr-btn--secondary fr-btn--sm" id="copyBtn">
                            Copier
                        </button>
                        <button type="button" class="fr-btn fr-btn--sm" id="testUrlBtn">
                            Tester
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="result-error-template">
        <div class="fr-alert fr-alert--error fr-mb-3w">
            <h3 class="fr-alert__title">Erreur</h3>
            <p id="error-message">-</p>
        </div>
    </template>

    <template id="test-result-template">
        <div class="fr-card fr-card--no-arrow fr-mb-3w">
            <div class="fr-card__body">
                <div class="fr-card__content">
                    <section class="fr-accordion">
                        <h3 class="fr-accordion__title">
                            <button type="button" class="fr-accordion__btn" aria-expanded="false" aria-controls="accordion-test-result">
                                <span id="accordion-title">Resultat JSON</span>
                            </button>
                        </h3>
                        <div id="accordion-test-result" class="fr-collapse">
                            <div class="fr-highlight">
                                <pre id="raw-result" class="fr-text--sm">Chargement...</pre>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </template>

    <!-- Grist Widget Initialization -->
    <script>
        // Initialiser le widget Grist
        grist.ready();

        // Activer le bouton de chargement si token ET doc_id pr√©sents
        function checkFields() {
            const hasApiKey = document.getElementById('api_key').value.trim().length > 0;
            const hasDocId = document.getElementById('doc_id').value.trim().length > 0;
            document.getElementById('loadTablesBtn').disabled = !(hasApiKey && hasDocId);
        }

        document.getElementById('api_key').addEventListener('input', checkFields);
        document.getElementById('doc_id').addEventListener('input', checkFields);
        
        console.log('Widget Moose initialise');
    </script>

    <!-- Script widget -->
    <script src="{{ url_for('static', filename='widget.js') }}"></script>
</body>
</html>
