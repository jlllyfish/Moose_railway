<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moose Widget</title>
    
    <!-- Grist Plugin API -->
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    
    <!-- DSFR CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='dsfr/dsfr.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='custom.css') }}">
    
    <style>
        body {
            margin: 0;
            padding: 1rem;
            font-family: Marianne, sans-serif;
        }
        .widget-container {
            max-width: 100%;
        }
        .fr-input-group {
            margin-bottom: 1rem;
        }
        .auto-filled {
            background-color: #f6f6f6;
            cursor: not-allowed;
        }
        .widget-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <!-- Header -->
        <div class="widget-header">
            <h1 class="fr-h4">ü¶å Moose - G√©n√©rateur d'URLs Grist</h1>
            <p class="fr-text--sm" style="color: #666; margin: 0;">Widget int√©gr√© - Doc ID automatique</p>
        </div>

        <!-- Formulaire -->
        <form id="widgetForm">
            <!-- Token API - Saisie manuelle -->
            <div class="fr-input-group">
                <label class="fr-label" for="api_key">
                    Token API Grist
                    <span class="fr-hint-text">Requis - Saisissez votre token personnel</span>
                </label>
                <input
                    class="fr-input"
                    type="password"
                    id="api_key"
                    name="api_key"
                    required
                    placeholder="Votre token API Grist"
                />
            </div>

            <!-- Document ID - Auto-rempli -->
            <div class="fr-input-group">
                <label class="fr-label" for="doc_id">
                    Document ID
                    <span class="fr-hint-text">Rempli automatiquement par Grist</span>
                </label>
                <input
                    class="fr-input auto-filled"
                    type="text"
                    id="doc_id"
                    name="doc_id"
                    readonly
                    placeholder="Chargement du Doc ID..."
                />
            </div>

            <!-- Bouton test API -->
            <div class="fr-mb-3w">
                <button
                    class="fr-btn fr-btn--secondary fr-btn--sm"
                    type="button"
                    id="testApiBtn"
                >
                    Tester le token
                </button>
            </div>

            <!-- Bouton charger tables -->
            <div class="fr-mb-3w">
                <button
                    type="button"
                    class="fr-btn fr-btn--secondary"
                    id="loadTablesBtn"
                    disabled
                >
                    Charger les tables
                </button>
            </div>

            <!-- S√©lection table -->
            <div class="fr-select-group fr-mb-3w">
                <label class="fr-label" for="table_name">Table</label>
                <select class="fr-select" id="table_name" name="table_name" required disabled>
                    <option value="">-- Charger d'abord les tables --</option>
                </select>
            </div>

            <!-- S√©lection colonne -->
            <div class="fr-select-group fr-mb-3w">
                <label class="fr-label" for="column_name">Colonne de filtre</label>
                <select class="fr-select" id="column_name" name="column_name" required disabled>
                    <option value="">-- Choisir d'abord une table --</option>
                </select>
            </div>

            <!-- Bouton g√©n√©rer -->
            <div class="fr-mb-3w">
                <button type="submit" class="fr-btn" id="generateBtn" disabled>
                    G√©n√©rer l'URL
                </button>
            </div>
        </form>

        <!-- R√©sultat -->
        <div id="result" style="display: none"></div>
        
        <!-- Chargement -->
        <div id="loading" style="display: none" class="fr-alert fr-alert--info">
            <p>G√©n√©ration en cours...</p>
        </div>
    </div>

    <!-- Modale -->
    <dialog aria-labelledby="modal-title" role="dialog" id="modal" class="fr-modal">
        <div class="fr-container fr-container--fluid fr-container-md">
            <div class="fr-grid-row fr-grid-row--center">
                <div class="fr-col-12">
                    <div class="fr-modal__body">
                        <div class="fr-modal__header">
                            <button class="fr-btn--close fr-btn" aria-controls="modal" title="Fermer">
                                Fermer
                            </button>
                        </div>
                        <div class="fr-modal__content">
                            <h1 id="modal-title" class="fr-modal__title">Information</h1>
                            <p id="modal-text">Message...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </dialog>

    <!-- Templates (m√™mes que index.html) -->
    <template id="result-success-template">
        <div class="fr-alert fr-alert--success fr-mb-3w">
            <h3 class="fr-alert__title">URL g√©n√©r√©e avec succ√®s</h3>
        </div>
        <div class="fr-card fr-card--no-arrow fr-mb-3w">
            <div class="fr-card__body">
                <div class="fr-card__content">
                    <h3 class="fr-card__title">URL g√©n√©r√©e</h3>
                    <div class="fr-highlight fr-mb-2w">
                        <pre id="generated-url" class="fr-text--sm" style="word-break: break-all;"></pre>
                    </div>
                    <div class="fr-btns-group fr-btns-group--inline">
                        <button type="button" class="fr-btn fr-btn--secondary fr-btn--sm" id="copyBtn">
                            Copier
                        </button>
                        <button type="button" class="fr-btn fr-btn--sm" id="testUrlBtn">
                            Tester
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="result-error-template">
        <div class="fr-alert fr-alert--error fr-mb-3w">
            <h3 class="fr-alert__title">Erreur</h3>
            <p id="error-message">-</p>
        </div>
    </template>

    <!-- Grist Widget Initialization -->
    <script>
        // Initialiser le widget Grist
        grist.ready({
            requiredAccess: 'none',
            columns: []
        });

        // R√©cup√©rer le Doc ID automatiquement
        grist.onReady(async function() {
            try {
                const docId = await grist.getDocId();
                document.getElementById('doc_id').value = docId;
                console.log('Doc ID r√©cup√©r√©:', docId);
            } catch (error) {
                console.error('Erreur r√©cup√©ration Doc ID:', error);
                document.getElementById('doc_id').value = '';
                document.getElementById('doc_id').placeholder = 'Erreur de r√©cup√©ration';
            }
        });

        // Activer le bouton de chargement si token ET doc_id pr√©sents
        document.getElementById('api_key').addEventListener('input', function() {
            const hasApiKey = this.value.trim().length > 0;
            const hasDocId = document.getElementById('doc_id').value.trim().length > 0;
            document.getElementById('loadTablesBtn').disabled = !(hasApiKey && hasDocId);
        });
    </script>

    <!-- Script principal (r√©utilise main.js) -->
    <script src="{{ url_for('static', filename='main.js') }}"></script>
</body>
</html>
