<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moose Widget</title>
    
    <!-- Grist Plugin API -->
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    
    <!-- DSFR CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='dsfr/dsfr.min.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='custom.css') }}">
    
    <style>
        body {
            margin: 0;
            padding: 1rem;
            font-family: Marianne, sans-serif;
        }
        .widget-container {
            max-width: 100%;
        }
        .fr-input-group {
            margin-bottom: 1rem;
        }
        .widget-header {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #ddd;
        }
    </style>
</head>
<body>
    <div class="widget-container">
        <!-- Header -->
        <div class="widget-header">
            <h1 class="fr-h4">ü¶å Moose - G√©n√©rateur d'URLs Grist</h1>
            <p class="fr-text--sm" style="color: #666; margin: 0;">Widget int√©gr√©</p>
        </div>

        <!-- Formulaire -->
        <div id="widgetForm">
            <!-- Token API - Saisie manuelle -->
            <div class="fr-input-group">
                <label class="fr-label" for="api_key">
                    Token API Grist
                    <span class="fr-hint-text">Requis - Saisissez votre token personnel</span>
                </label>
                <input
                    class="fr-input"
                    type="password"
                    id="api_key"
                    name="api_key"
                    required
                    placeholder="Votre token API Grist"
                />
            </div>

            <!-- Document ID - Saisie manuelle -->
            <div class="fr-input-group">
                <label class="fr-label" for="doc_id">
                    Document ID
                    <span class="fr-hint-text">Trouvez l'ID dans l'URL de votre document Grist</span>
                </label>
                <input
                    class="fr-input"
                    type="text"
                    id="doc_id"
                    name="doc_id"
                    required
                    placeholder="Ex: cTdjBRNu26yTzGusvQKffu"
                />
                <div class="fr-hint-text" style="margin-top: 0.25rem;">
                    URL Grist : https://grist.../doc/<strong>VOTRE_DOC_ID</strong>/...
                </div>
            </div>

            <!-- Bouton test API -->
            <div class="fr-mb-3w">
                <button
                    class="fr-btn fr-btn--secondary fr-btn--sm"
                    type="button"
                    id="testApiBtn"
                >
                    Tester le token
                </button>
            </div>

            <!-- Bouton charger tables -->
            <div class="fr-mb-3w">
                <button
                    type="button"
                    class="fr-btn fr-btn--secondary"
                    id="loadTablesBtn"
                    disabled
                >
                    Charger les tables
                </button>
            </div>

            <!-- S√©lection table -->
            <div class="fr-select-group fr-mb-3w">
                <label class="fr-label" for="table_name">Table</label>
                <select class="fr-select" id="table_name" name="table_name" required disabled>
                    <option value="">-- Charger d'abord les tables --</option>
                </select>
            </div>

            <!-- S√©lection colonne -->
            <div class="fr-select-group fr-mb-3w">
                <label class="fr-label" for="column_name">Colonne de filtre</label>
                <select class="fr-select" id="column_name" name="column_name" required disabled>
                    <option value="">-- Choisir d'abord une table --</option>
                </select>
            </div>

            <!-- Bouton g√©n√©rer -->
            <div class="fr-mb-3w">
                <button type="button" class="fr-btn" id="generateBtn" disabled>
                    G√©n√©rer l'URL
                </button>
            </div>
        </div>

        <!-- R√©sultat -->
        <div id="result" style="display: none"></div>
        
        <!-- Chargement -->
        <div id="loading" style="display: none" class="fr-alert fr-alert--info">
            <p>G√©n√©ration en cours...</p>
        </div>
    </div>

    <!-- Modale -->
    <dialog aria-labelledby="modal-title" role="dialog" id="modal" class="fr-modal">
        <div class="fr-container fr-container--fluid fr-container-md">
            <div class="fr-grid-row fr-grid-row--center">
                <div class="fr-col-12">
                    <div class="fr-modal__body">
                        <div class="fr-modal__header">
                            <button class="fr-btn--close fr-btn" aria-controls="modal" title="Fermer">
                                Fermer
                            </button>
                        </div>
                        <div class="fr-modal__content">
                            <h1 id="modal-title" class="fr-modal__title">Information</h1>
                            <p id="modal-text">Message...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </dialog>

    <!-- Templates -->
    <template id="result-success-template">
        <div class="fr-alert fr-alert--success fr-mb-3w">
            <h3 class="fr-alert__title">URL generee avec succes</h3>
        </div>
        <div class="fr-card fr-card--no-arrow fr-mb-3w">
            <div class="fr-card__body">
                <div class="fr-card__content">
                    <h3 class="fr-card__title">URL generee</h3>
                    <div class="fr-highlight fr-mb-2w">
                        <pre id="generated-url" class="fr-text--sm" style="word-break: break-all;"></pre>
                    </div>
                    <div class="fr-mb-2w">
                        <dl class="fr-metadata">
                            <dt>Document :</dt>
                            <dd id="doc-name">-</dd>
                            <dt>Table :</dt>
                            <dd id="table-name">-</dd>
                            <dt>Colonne :</dt>
                            <dd id="column-name">-</dd>
                        </dl>
                    </div>
                    <div class="fr-btns-group fr-btns-group--inline">
                        <button type="button" class="fr-btn fr-btn--secondary fr-btn--sm" id="copyBtn">
                            Copier
                        </button>
                        <button type="button" class="fr-btn fr-btn--sm" id="testUrlBtn">
                            Tester
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="result-error-template">
        <div class="fr-alert fr-alert--error fr-mb-3w">
            <h3 class="fr-alert__title">Erreur</h3>
            <p id="error-message">-</p>
        </div>
    </template>

    <template id="test-result-template">
        <div class="fr-card fr-card--no-arrow fr-mb-3w">
            <div class="fr-card__body">
                <div class="fr-card__content">
                    <h3 class="fr-card__title">Resultat du test</h3>
                    <section class="fr-accordion">
                        <h3 class="fr-accordion__title">
                            <button type="button" class="fr-accordion__btn" aria-expanded="false" aria-controls="accordion-test-result">
                                <span id="accordion-title">Resultat JSON</span>
                            </button>
                        </h3>
                        <div id="accordion-test-result" class="fr-collapse">
                            <div class="fr-highlight">
                                <pre id="raw-result" class="fr-text--sm">Chargement...</pre>
                            </div>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </template>

    <!-- Grist Widget Initialization -->
    <script>
        // Initialiser le widget Grist
        grist.ready();

        // Activer le bouton de chargement si token ET doc_id pr√©sents
        function checkFields() {
            const hasApiKey = document.getElementById('api_key').value.trim().length > 0;
            const hasDocId = document.getElementById('doc_id').value.trim().length > 0;
            document.getElementById('loadTablesBtn').disabled = !(hasApiKey && hasDocId);
        }

        document.getElementById('api_key').addEventListener('input', checkFields);
        document.getElementById('doc_id').addEventListener('input', checkFields);
        
        console.log('Widget Moose initialise');
    </script>

    <!-- Script widget specifique -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Gestionnaire pour le bouton g√©n√©rer
        document.getElementById('generateBtn').addEventListener('click', function() {
            const formData = new FormData();
            formData.append('api_key', document.getElementById('api_key').value);
            formData.append('doc_id', document.getElementById('doc_id').value);
            formData.append('table_name', document.getElementById('table_name').value);
            formData.append('column_name', document.getElementById('column_name').value);
            
            const loading = document.getElementById('loading');
            const result = document.getElementById('result');
            
            loading.style.display = 'block';
            result.style.display = 'none';
            
            fetch('/generate_url', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                loading.style.display = 'none';
                
                if (data.url) {
                    // Afficher le r√©sultat
                    const template = document.getElementById('result-success-template');
                    const clone = template.content.cloneNode(true);
                    
                    clone.getElementById('generated-url').textContent = data.url;
                    clone.getElementById('doc-name').textContent = data.doc_name || 'Document';
                    clone.getElementById('table-name').textContent = data.table;
                    clone.getElementById('column-name').textContent = data.column;
                    
                    // Bouton copier
                    clone.getElementById('copyBtn').addEventListener('click', () => {
                        navigator.clipboard.writeText(data.url)
                            .then(() => alert('URL copiee !'))
                            .catch(() => alert('Erreur de copie'));
                    });
                    
                    // Bouton tester
                    clone.getElementById('testUrlBtn').addEventListener('click', () => {
                        const testId = prompt('Entrez une valeur de test pour remplacer {id}:', 'test');
                        if (testId) {
                            testUrl(data.url, testId);
                        }
                    });
                    
                    result.innerHTML = '';
                    result.appendChild(clone);
                    result.style.display = 'block';
                } else {
                    const template = document.getElementById('result-error-template');
                    const clone = template.content.cloneNode(true);
                    clone.getElementById('error-message').textContent = data.error || 'Erreur inconnue';
                    result.innerHTML = '';
                    result.appendChild(clone);
                    result.style.display = 'block';
                }
            })
            .catch(error => {
                loading.style.display = 'none';
                const template = document.getElementById('result-error-template');
                const clone = template.content.cloneNode(true);
                clone.getElementById('error-message').textContent = 'Erreur: ' + error.message;
                result.innerHTML = '';
                result.appendChild(clone);
                result.style.display = 'block';
            });
        });
        
        // Fonction pour tester l'URL
        function testUrl(url, testValue) {
            const apiKey = document.getElementById('api_key').value;
            
            fetch('/test_url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    url: url,
                    test_value: testValue,
                    api_key: apiKey
                })
            })
            .then(response => response.json())
            .then(data => {
                const template = document.getElementById('test-result-template');
                const clone = template.content.cloneNode(true);
                
                if (data.success) {
                    const recordCount = data.data.records ? data.data.records.length : 0;
                    clone.getElementById('raw-result').textContent = JSON.stringify(data.data, null, 2);
                    clone.getElementById('accordion-title').textContent = 
                        'Resultat JSON (' + recordCount + ' enregistrement' + (recordCount > 1 ? 's' : '') + ')';
                } else {
                    clone.getElementById('raw-result').textContent = 'Erreur: ' + data.error;
                    clone.getElementById('accordion-title').textContent = 'Erreur lors du test';
                }
                
                // Ajouter le r√©sultat de test
                const testContainer = document.createElement('div');
                testContainer.setAttribute('data-test-result', 'true');
                testContainer.appendChild(clone);
                document.getElementById('result').appendChild(testContainer);
            })
            .catch(error => {
                alert('Erreur test: ' + error.message);
            });
        }
    });
    </script>

    <!-- Script principal (pour les autres fonctionnalit√©s) -->
    <script src="{{ url_for('static', filename='main.js') }}"></script>
</body>
</html>
